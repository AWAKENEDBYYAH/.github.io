<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password | Awakened By YAH</title>

  <link rel="icon" type="image/png" href="/abytransparent.png">
  <link rel="canonical" href="https://awakenedbyyahmusic.com/reset/" />

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:#020617;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .card{
      width:min(420px, 92vw);
      padding:24px;
      border-radius:20px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    h1{ margin:0 0 10px; letter-spacing:.06em; }
    p{ margin:0 0 16px; color:#94a3b8; font-size:14px; }
    label{ display:block; font-size:12px; color:#94a3b8; margin:12px 0 6px; }
    input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      background:#020617;
      color:#e5e7eb;
      outline:none;
    }
    button{
      margin-top:16px;
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(43,86,255,.6);
      background:linear-gradient(135deg, rgba(28,57,168,.7), rgba(43,86,255,.3));
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .toast{
      margin-top:14px;
      font-size:13px;
      color:#bbf7d0;
      display:none;
      word-break:break-word;
    }
    .toast.bad{color:#fecaca}
    .small{font-size:12px;color:#94a3b8;margin-top:10px}
    .small code{color:#e5e7eb}
  </style>
</head>

<body>
  <div class="card">
    <h1>Reset Password</h1>
    <p id="status">Checking your reset link…</p>

    <label for="password">New password</label>
    <input id="password" type="password" placeholder="At least 8 characters" autocomplete="new-password"/>

    <label for="password2">Confirm password</label>
    <input id="password2" type="password" placeholder="Confirm password" autocomplete="new-password"/>

    <button id="resetBtn" type="button" disabled>UPDATE PASSWORD</button>

    <div id="toast" class="toast"></div>
    <div class="small" id="debug"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://fgqzopgqtownfvohtlcq.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable__LlL7rsAYeDlub9OmvofaA_ck1tKqca";

    const statusEl = document.getElementById("status");
    const toast = document.getElementById("toast");
    const debugEl = document.getElementById("debug");
    const passwordEl = document.getElementById("password");
    const password2El = document.getElementById("password2");
    const resetBtn = document.getElementById("resetBtn");

    function show(msg, bad=false){
      toast.textContent = msg;
      toast.className = "toast" + (bad ? " bad" : "");
      toast.style.display = "block";
    }
    function setStatus(msg){ statusEl.textContent = msg; }
    function dbg(msg){
      debugEl.innerHTML = msg;
    }

    // If Supabase failed to load, we MUST tell you (this is the #1 "nothing happened" cause)
    if (!window.supabase) {
      setStatus("Error loading reset system.");
      show("Supabase library did not load. Try a hard refresh (Ctrl+F5) and try again.", true);
      dbg("Debug: <code>window.supabase</code> is missing (CDN blocked or not loaded).");
      throw new Error("Supabase JS not loaded");
    }

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_PUBLISHABLE_KEY,
      {
        auth: {
          detectSessionInUrl: true,   // handles #access_token links
          persistSession: true,
          autoRefreshToken: true
        }
      }
    );

    let recoveryReady = false;

    async function activateRecoverySession() {
      try {
        // ✅ Handles the NEWER Supabase reset links: ?code=xxxx
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");

        if (code) {
          setStatus("Activating reset link…");
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) {
            show("Reset link invalid/expired. Please request a new one.", true);
            dbg("Debug: exchangeCodeForSession error: <code>" + (error.message || error) + "</code>");
            return false;
          }

          // remove ?code= from the URL to avoid re-exchanging on refresh
          url.searchParams.delete("code");
          window.history.replaceState({}, document.title, url.pathname + url.search + url.hash);
        }

        // ✅ Handles HASH style links via detectSessionInUrl + existing session check
        const { data, error } = await supabase.auth.getSession();
        if (error || !data?.session) {
          show("Invalid or expired reset link. Please request a new one.", true);
          dbg("Debug: getSession result: <code>" + (error?.message || "no session") + "</code><br>URL: <code>" + window.location.href + "</code>");
          return false;
        }

        recoveryReady = true;
        resetBtn.disabled = false;
        setStatus("Reset link active. Enter a new password.");
        dbg("Debug: recovery session is active ✅");
        return true;

      } catch (e) {
        show("Something blocked the reset flow on this page.", true);
        dbg("Debug: exception: <code>" + (e?.message || e) + "</code>");
        return false;
      }
    }

    // Activate on load
    activateRecoverySession();

    resetBtn.addEventListener("click", async () => {
      if (!recoveryReady) {
        show("Reset link not active yet. Reload or request a new link.", true);
        return;
      }

      const p1 = (passwordEl.value || "").trim();
      const p2 = (password2El.value || "").trim();

      if (!p1 || p1.length < 8){
        show("Password must be at least 8 characters.", true);
        return;
      }
      if (p1 !== p2){
        show("Passwords do not match.", true);
        return;
      }

      resetBtn.disabled = true;
      setStatus("Updating password…");

      const { error } = await supabase.auth.updateUser({ password: p1 });

      if (error){
        resetBtn.disabled = false;
        setStatus("Reset failed.");
        show("Reset failed: " + (error.message || "Unknown error") + ". Request a new reset link and try again.", true);
        dbg("Debug: updateUser error: <code>" + (error.message || error) + "</code>");
        return;
      }

      show("Password updated. Redirecting…");
      setStatus("Done ✅ Redirecting…");
      setTimeout(() => {
        window.location.href = "/login/";
      }, 1200);
    });
  </script>
</body>
</html>
